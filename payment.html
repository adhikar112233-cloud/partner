<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Payment - BIGYAPON</title>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background-color: #f9fafb; 
        }
        .card { 
            background: white; 
            padding: 2.5rem; 
            border-radius: 1rem; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            border: 1px solid #e5e7eb;
        }
        h2 { 
            color: #111827; 
            margin-bottom: 0.5rem; 
            font-size: 1.5rem;
        }
        p.subtitle {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0;
            margin-bottom: 2rem;
        }
        .input-group {
            text-align: left;
            margin-bottom: 1rem;
        }
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        input { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            box-sizing: border-box; 
            font-size: 1rem; 
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        button { 
            width: 100%; 
            background: linear-gradient(to right, #2dd4bf, #4f46e5); 
            color: white; 
            padding: 0.875rem; 
            border: none; 
            border-radius: 0.5rem; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            margin-top: 1rem;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        .logo { 
            font-size: 2rem; 
            font-weight: 900; 
            background: -webkit-linear-gradient(0deg, #00c6fb, #005bea); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 0.5rem; 
            display: inline-block; 
            letter-spacing: -1px;
        }
        .error { 
            color: #ef4444; 
            font-size: 0.875rem; 
            margin-top: 1rem; 
            background-color: #fef2f2;
            padding: 0.5rem;
            border-radius: 0.375rem;
            display: none; 
        }
        .secure-badge {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            color: #6b7280;
            font-size: 0.75rem;
            gap: 0.5rem;
        }
        .secure-badge svg { width: 12px; height: 12px; }
    </style>
</head>
<body>

    <div class="card">
        <div class="logo">BIGYAPON</div>
        <h2>Secure Payment</h2>
        <p class="subtitle">Enter details to proceed</p>
        
        <div class="input-group">
            <label for="amount">Amount (â‚¹)</label>
            <input id="amount" type="number" placeholder="Enter Amount" min="1">
        </div>

        <div class="input-group">
            <label for="phone">Mobile Number</label>
            <input id="phone" type="tel" placeholder="10-digit Mobile Number" maxlength="10">
        </div>
        
        <button id="payBtn">Pay Now</button>
        <p id="errorMsg" class="error"></p>

        <div class="secure-badge">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
            Secured by Cashfree Payments
        </div>
    </div>

    <script>
        const backendURL = "https://us-central1-bigyapon2-cfa39.cloudfunctions.net/createPayment";
        const payBtn = document.getElementById("payBtn");
        const errorMsg = document.getElementById("errorMsg");

        payBtn.addEventListener("click", async () => {
            const amount = document.getElementById("amount").value;
            const phone = document.getElementById("phone").value;

            errorMsg.style.display = 'none';
            
            if (!amount || amount <= 0) {
                showError("Please enter a valid amount greater than 0.");
                return;
            }
            if (!phone || phone.length < 10) {
                showError("Please enter a valid 10-digit mobile number.");
                return;
            }

            payBtn.disabled = true;
            payBtn.innerText = "Processing...";

            try {
                // 1. Create Order
                // We pass a generated customerId so the backend doesn't reject it for missing userId
                const guestId = "GUEST_" + Date.now();
                
                const response = await fetch(backendURL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        amount: Number(amount),
                        phone: phone,
                        customerId: guestId, 
                        collabType: "direct", // Default type for standalone page
                        purpose: "Web Payment",
                        // Pass generic IDs to satisfy backend schema if needed
                        relatedId: "payment_page_" + Date.now(),
                        collabId: "PAY_" + Date.now()
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || "Failed to initiate payment");
                }

                const paymentSessionId = data.paymentSessionId || data.payment_session_id;

                if (!paymentSessionId) {
                    throw new Error("Session ID missing from response");
                }

                // 2. Checkout
                // IMPORTANT: Ensure the mode matches your backend (sandbox vs production)
                // The backend response usually tells us the environment, or we default to production for live URL
                const mode = data.environment || "production"; 
                const cashfree = Cashfree({ mode: mode });
                
                await cashfree.checkout({
                    paymentSessionId: paymentSessionId,
                    redirectTarget: "_self"
                });

            } catch (err) {
                console.error(err);
                showError(err.message || "An error occurred. Please try again.");
                resetBtn();
            }
        });

        function showError(msg) {
            errorMsg.innerText = msg;
            errorMsg.style.display = 'block';
        }

        function resetBtn() {
            payBtn.disabled = false;
            payBtn.innerText = "Pay Now";
        }
    </script>

</body>
</html>